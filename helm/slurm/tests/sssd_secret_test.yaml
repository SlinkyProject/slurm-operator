# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
---
suite: test sssd config secret
templates:
- cluster/sssd-conf-secret.yaml
release:
  name: test-release
  namespace: test-namespace
chart:
  version: 1.2.3
  appVersion: 1.2.3
tests:
- it: should not render when no loginsets or nodesets with SSH are enabled
  set:
    loginsets:
      slinky:
        enabled: false
    nodesets:
      slinky:
        enabled: true
        ssh:
          enabled: false
  asserts:
  - hasDocuments:
      count: 0

- it: should render correctly when a loginset is enabled
  set:
    loginsets:
      slinky:
        enabled: true
    sssd:
      conf: |
        [sssd]
        config_file_version = 2
  asserts:
  - hasDocuments:
      count: 1
  - equal:
      path: kind
      value: Secret
  - equal:
      path: type
      value: Opaque
  - equal:
      path: metadata.name
      value: test-release-slurm-sssd-conf
  - equal:
      path: metadata.namespace
      value: test-namespace
  - exists:
      path: stringData["sssd.conf"]

- it: should render when a nodeset with SSH is enabled
  set:
    loginsets:
      slinky:
        enabled: false
    nodesets:
      slinky:
        enabled: true
        ssh:
          enabled: true
    sssd:
      conf: |
        [sssd]
        config_file_version = 2
  asserts:
  - hasDocuments:
      count: 1
  - equal:
      path: kind
      value: Secret

- it: should not render when secretRef is set
  set:
    loginsets:
      slinky:
        enabled: true
    sssd:
      secretRef:
        name: my-sssd-secret
        key: sssd.conf
      conf: |
        [sssd]
        config_file_version = 2
  asserts:
  - hasDocuments:
      count: 0

- it: should override namespace when namespaceOverride is set
  set:
    namespaceOverride: custom-namespace
    loginsets:
      slinky:
        enabled: true
    sssd:
      conf: |
        [sssd]
        config_file_version = 2
  asserts:
  - equal:
      path: metadata.namespace
      value: custom-namespace
