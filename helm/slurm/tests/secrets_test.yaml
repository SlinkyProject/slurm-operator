# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
---
suite: test secrets
templates:
- secrets/jwths256key.yaml
- secrets/slurmkey.yaml
release:
  name: test-release
  namespace: test-namespace
kubernetesProvider:
  scheme:
    "v1/Secret":
      gvr:
        version: "v1"
        resource: "secrets"
      namespaced: true
tests:
- it: should not create a jwt hs256 secret if it exists
  template: secrets/jwths256key.yaml
  kubernetesProvider:
    objects:
      - kind: Secret
        apiVersion: v1
        metadata:
          name: test-release-slurm-auth-jwths256
          namespace: test-namespace
        data:
          jwt_hs256.key: dGVzdAo=
  asserts:
  - hasDocuments:
      count: 0

- it: should not create a jwt hs256 secret if controller and accounting are external
  template: secrets/jwths256key.yaml
  set:
    controller:
      external: true
    accounting:
      external: true
    jwtKey:
      create: true
  asserts:
  - hasDocuments:
      count: 0

- it: should not create a jwt hs256 secret if create is set to false
  template: secrets/jwths256key.yaml
  set:
    jwtKey:
      create: false
  asserts:
  - hasDocuments:
      count: 0

- it: should create a jwt hs256 secret with a custom name and key if create is set to true and a name and key are specified
  template: secrets/jwths256key.yaml
  set:
    jwtKey:
      create: true
      secretRef:
        name: custom-jwths256-secret-name
        key: custom_jwtjs256_key
  asserts:
  - equal:
      path: metadata.name
      value: custom-jwths256-secret-name
  - exists:
      path: data.custom_jwtjs256_key

- it: should set secret annotations on created jwt hs256 secret when set
  template: secrets/jwths256key.yaml
  set:
    jwtKey:
      create: true
      annotations:
        secrets.slinky.slurm.net/annotation: "present"
  asserts:
  - equal:
      path: metadata.annotations
      value: {helm.sh/resource-policy: keep, secrets.slinky.slurm.net/annotation: "present"}

- it: should not create a slurm secret if it exists
  template: secrets/slurmkey.yaml
  kubernetesProvider:
    objects:
      - kind: Secret
        apiVersion: v1
        metadata:
          name: test-release-slurm-auth-slurm
          namespace: test-namespace
        data:
          slurm.key: dGVzdAo=
  asserts:
  - hasDocuments:
      count: 0

- it: should not create a slurm secret if controller and accounting are external
  template: secrets/slurmkey.yaml
  set:
    controller:
      external: true
    accounting:
      external: true
    slurmKey:
      create: true
  asserts:
  - hasDocuments:
      count: 0

- it: should not create a slurm secret if create is set to false
  template: secrets/slurmkey.yaml
  set:
    slurmKey:
      create: false
  asserts:
  - hasDocuments:
      count: 0


- it: should create a slurm secret with a custom name and key if create is set to true and a name and key are specified
  template: secrets/slurmkey.yaml
  set:
    slurmKey:
      create: true
      secretRef:
        name: custom-slurm-secret-name
        key: custom_slurm_key
  asserts:
  - equal:
      path: metadata.name
      value: custom-slurm-secret-name
  - exists:
      path: data.custom_slurm_key

- it: should set secret annotations on created slurm secret when set
  template: secrets/slurmkey.yaml
  set:
    slurmKey:
      create: true
      annotations:
        secrets.slinky.slurm.net/annotation: "present"
  asserts:
  - equal:
      path: metadata.annotations
      value: {helm.sh/resource-policy: keep, secrets.slinky.slurm.net/annotation: "present"}
