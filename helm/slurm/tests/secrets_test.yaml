# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
---
suite: test secrets
templates:
- secrets/jwths256key.yaml
- secrets/slurmkey.yaml
release:
  name: test-release
  namespace: test-namespace
kubernetesProvider:
  scheme:
    "v1/Secret":
      gvr:
        version: "v1"
        resource: "secrets"
      namespaced: true
tests:
- it: should not create a jwt hs256 secret if it exists
  template: secrets/jwths256key.yaml
  kubernetesProvider:
    objects:
      - kind: Secret
        apiVersion: v1
        metadata:
          name: slurm-auth-jwths256
          namespace: test-namespace
        data:
          jwt_hs256.key: dGVzdAo=
  asserts:
  - hasDocuments:
      count: 0

- it: should not create a slurm secret if controller and accounting are external
  template: secrets/jwths256key.yaml
  set:
    controller:
      external: true
    accounting:
      external: true
  asserts:
  - hasDocuments:
      count: 0

- it: should not create a jwt hs256 secret disabled by values
  template: secrets/jwths256key.yaml
  set:
    jwtHs256KeyRef:
      create: false
  asserts:
  - hasDocuments:
      count: 0

- it: should add annotations to the jwt hs256 secret
  template: secrets/jwths256key.yaml
  set:
    jwtHs256KeyRef:
      annotations:
        foo: bar
  asserts:
  - equal:
      path: metadata.annotations.foo
      value: bar


- it: should not create a slurm secret if it exists
  template: secrets/slurmkey.yaml
  kubernetesProvider:
    objects:
      - kind: Secret
        apiVersion: v1
        metadata:
          name: slurm-auth-slurm
          namespace: test-namespace
        data:
          slurm.key: dGVzdAo=
  asserts:
  - hasDocuments:
      count: 0

- it: should not create a slurm secret if controller and accounting are external
  template: secrets/slurmkey.yaml
  set:
    controller:
      external: true
    accounting:
      external: true
  asserts:
  - hasDocuments:
      count: 0

- it: should not create a slurm secret if disabled by values
  template: secrets/slurmkey.yaml
  set:
    slurmKeyRef:
      create: false
  asserts:
  - hasDocuments:
      count: 0

- it: should add annotations to the slurm secret
  template: secrets/slurmkey.yaml
  set:
    slurmKeyRef:
      annotations:
        foo: bar
  asserts:
  - equal:
     path: metadata.annotations.foo
     value: bar
