# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
---
suite: test webhook poddisruptionbudget
templates:
- webhook/poddisruptionbudget.yaml
chart:
  version: 1.2.3
  appVersion: 1.2.3
release:
  name: test-release
  namespace: test-namespace
tests:
- it: should not render when webhook is disabled
  set:
    webhook:
      enabled: false
  asserts:
  - hasDocuments:
      count: 0

- it: should not render when pdb is not enabled
  set:
    webhook:
      enabled: true
      pdb:
        enabled: false
  asserts:
  - hasDocuments:
      count: 0

- it: should render with correct metadata and spec when pdb is enabled
  set:
    webhook:
      enabled: true
      pdb:
        enabled: true
        minAvailable: 1
  asserts:
  - hasDocuments:
      count: 1
  - equal:
      path: apiVersion
      value: policy/v1
  - equal:
      path: kind
      value: PodDisruptionBudget
  - equal:
      path: metadata.name
      value: slurm-operator-webhook
  - equal:
      path: metadata.namespace
      value: test-namespace
  - equal:
      path: spec.minAvailable
      value: 1
  - exists:
      path: spec.selector.matchLabels

- it: should set custom minAvailable
  set:
    webhook:
      enabled: true
      pdb:
        enabled: true
        minAvailable: 3
  asserts:
  - equal:
      path: spec.minAvailable
      value: 3

- it: should override namespace when namespaceOverride is set
  set:
    namespaceOverride: custom-namespace
    webhook:
      enabled: true
      pdb:
        enabled: true
        minAvailable: 1
  asserts:
  - equal:
      path: metadata.namespace
      value: custom-namespace
